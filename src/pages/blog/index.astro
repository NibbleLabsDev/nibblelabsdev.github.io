---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import PostCard from '../../components/PostCard.astro';

const currentPage = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 10;

const allPosts = (await getCollection('blog'))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const totalPages = Math.ceil(allPosts.length / perPage);
const posts = allPosts.slice((currentPage - 1) * perPage, currentPage * perPage);

function readingTime(body: string): number {
  return Math.max(1, Math.ceil(body.split(/\s+/).length / 200));
}
---

<Base title="Blog">
  <h1 class="font-heading text-3xl font-semibold mb-6">Blog</h1>

  <div class="flex flex-col gap-4">
    {posts.map((post) => (
      <PostCard
        title={post.data.title}
        description={post.data.description}
        pubDate={post.data.pubDate}
        slug={post.id}
        readingTime={readingTime(post.body ?? '')}
      />
    ))}
  </div>

  {totalPages > 1 && (
    <nav class="mt-8 flex items-center justify-center gap-4 text-sm">
      {currentPage > 1 && <a href={`/blog?page=${currentPage - 1}`} class="hover:opacity-80">&larr; Previous</a>}
      <span class="text-gray-500">Page {currentPage} of {totalPages}</span>
      {currentPage < totalPages && <a href={`/blog?page=${currentPage + 1}`} class="hover:opacity-80">Next &rarr;</a>}
    </nav>
  )}
</Base>
